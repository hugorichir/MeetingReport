<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const SUPABASE_URL = "https://jniduojcihgdktmrkmth.supabase.co"; // Replace with your Supabase URL
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuaWR1b2pjaWhnZGt0bXJrbXRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM3NDc1NzAsImV4cCI6MjA0OTMyMzU3MH0.3jWkZ1FdNFOFfnzBXEX1GQS2q8-tQ4VvxGwYcbqLO9M"; // Replace with your Supabase Key
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : createSupabaseClient(SUPABASE_URL, SUPABASE_KEY);

       document.addEventListener("DOMContentLoaded", function () {
        const loginSection = document.getElementById('login-section');
        const createOrgSection = document.getElementById('create-organization-section');

            window.showCreateOrganizationForm = function() {
                loginSection.style.display = 'none';
                createOrgSection.style.display = 'block';
            };
           
           async function checkOrganizationExists(orgName) {
        try {
            const { data, error } = await supabase
                .from('organizations') // Replace with your table name
                .select('name')
                .eq('name', orgName);

            if (error) {
                console.error('Error checking organization existence:', error);
                alert('Une erreur est survenue lors de la vérification du nom d\'organisation.');
                return false;
            }

            return data.length > 0; // Returns true if organization exists
        } catch (error) {
            console.error('Unexpected error:', error);
            alert('Une erreur inattendue est survenue.');
            return false;
        }
    }
           
        function generateRandomID() {
            return Math.random().toString(36).substr(2, 9);
        }

        async function uploadImageToSupabase(file, orgID) {
    const fileName = `${orgID}/${file.name}`;
    try {
        const { data, error } = await supabase.storage
            .from('organization-photos') // Ensure this matches your bucket name
            .upload(fileName, file, {
                cacheControl: '3600',
                upsert: false, // Prevent overwriting files
            });

        if (error) {
            console.error('Error uploading file:', error);
            alert('Erreur lors du téléversement de l\'image.');
            return null;
        }

        // Get the public URL for the uploaded file
        const { publicUrl } = supabase.storage
            .from('organization-photos')
            .getPublicUrl(fileName);

        return publicUrl;
    } catch (error) {
        console.error('Unexpected error during file upload:', error);
        alert('Une erreur inattendue est survenue lors du téléversement.');
        return null;
    }
}

        async function saveOrganizationToSupabase(orgName, orgID, photoUrl) {
            try {
                const { data, error } = await supabase
                    .from('organizations') // Replace with your table name
                    .insert([{ id: orgID, name: orgName, photo_url: photoUrl }]);

                if (error) {
                    console.error('Error saving to Supabase:', error);
                    alert('Une erreur est survenue lors de l\'enregistrement de l\'organisation.');
                } else {
                    alert(`Organisation "${orgName}" enregistrée avec succès !`);
                }
            } catch (error) {
                console.error('Unexpected error:', error);
                alert('Une erreur inattendue est survenue.');
            }
        }

      window.createOrganization = async function () {
    const orgName = document.getElementById('new-organization-name').value.trim();
    const orgPhoto = document.getElementById('organization-photo').files[0];

    if (!orgName) {
        alert('Veuillez entrer un nom d\'organisation.');
        return;
    }

    const orgID = generateRandomID();
    let photoUrl = null;

    if (orgPhoto) {
        photoUrl = await uploadImageToSupabase(orgPhoto, orgID);
        if (!photoUrl) {
            alert('Erreur lors du téléversement de la photo.');
            return;
        }
    }

    try {
        await saveOrganizationToSupabase(orgName, orgID, photoUrl);
    } catch (error) {
        console.error('Unexpected error during organization creation:', error);
        alert('Une erreur inattendue est survenue lors de la création de l\'organisation.');
    }
};


        window.goBackToLogin = function () {
            createOrgSection.style.display = 'none';
            loginSection.style.display = 'block';
        };
    });

    /**
     * Supabase Table Example:
     * Table Name: organizations
     * Columns:
     * - id (text, primary key)
     * - name (text)
     * - photo_url (text)
     */
    </script>
</head>

<body>
    <header class="header">
        <h1>Bienvenue</h1>
    </header>

    <!-- Login Section -->
    <section id="login-section">
        <h2>Connectez-vous à votre organisation</h2>
        <input type="text" id="organization-id" placeholder="ID de l'organisation">
        <button onclick="alert('Connexion en cours...')">Se connecter</button>
        <button onclick="showCreateOrganizationForm()">Créer une organisation</button>
    </section>

    <!-- Create Organization Section -->
    <section id="create-organization-section" style="display: none;">
        <h2>Créer une nouvelle organisation</h2>
        <form id="create-organization-form">
            <label for="new-organization-name">Nom de l'organisation :</label>
            <input type="text" id="new-organization-name" placeholder="Nom de l'organisation" required>
            <br>
            <label for="organization-photo">Ajouter une photo :</label>
            <input type="file" id="organization-photo" accept="image/*">
            <br>
            <button type="button" onclick="createOrganization()">Créer</button>
            <button type="button" onclick="goBackToLogin()">Retour</button>
        </form>
    </section>
</body>

</html>